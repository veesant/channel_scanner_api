name: Weekly Channel Scan API (Optimized + Sharded)

on:
  schedule:
    - cron: "30 20 * * *"   # Daily 20:30 UTC
  workflow_dispatch:
    inputs:
      mode:
        description: "What to run"
        required: true
        default: "all"
        type: choice
        options:
          - entry_only
          - all
          - corr_wl
          - sideways
          - downtoup
          - bullflag
          - catchall

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  # -------------------------
  # ENTRY SIGNALS
  # -------------------------
  entry:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'entry_only' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        market:
          - { out: nifty50, file: data/nifty50.txt }
          - { out: nse_01, file: data/nse_01.txt }
          - { out: nse_02, file: data/nse_02.txt }
          - { out: nse_03, file: data/nse_03.txt }
          - { out: nse_04, file: data/nse_04.txt }
          - { out: nse_05, file: data/nse_05.txt }
          - { out: nasdaq_01, file: data/nasdaq_01.txt }
          - { out: nasdaq_02, file: data/nasdaq_02.txt }
          - { out: nasdaq_03, file: data/nasdaq_03.txt }
          - { out: nasdaq_04, file: data/nasdaq_04.txt }
          - { out: nasdaq_05, file: data/nasdaq_05.txt }
          - { out: nasdaq_06, file: data/nasdaq_06.txt }
          - { out: nyse_01, file: data/nyse_01.txt }
          - { out: nyse_02, file: data/nyse_02.txt }
          - { out: nyse_03, file: data/nyse_03.txt }
          - { out: nyse_04, file: data/nyse_04.txt }
          - { out: nyse_05, file: data/nyse_05.txt }
          - { out: nyse_06, file: data/nyse_06.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/entry

      - name: Run Entry Signal
        run: |
          python scanners/entry_sig_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --use_range_levels_for_entry \
            --recent_hl_lookback_bars 20 \
            --recent_hl_count 2 \
            --recent_hl_slope_min_pct_per_bar 0.02 \
            --out api/entry/${{ matrix.market.out }}.json

      - uses: actions/upload-artifact@v4
        with:
          name: entry-api-${{ matrix.market.out }}
          path: api/entry/${{ matrix.market.out }}.json
          if-no-files-found: error

  # -------------------------
  # CORRECTION WATCHLIST
  # -------------------------
  corrwl:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'corr_wl' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        market:
          - { out: nifty50, file: data/nifty50.txt }
          - { out: nse_01, file: data/nse_01.txt }
          - { out: nse_02, file: data/nse_02.txt }
          - { out: nse_03, file: data/nse_03.txt }
          - { out: nse_04, file: data/nse_04.txt }
          - { out: nse_05, file: data/nse_05.txt }
          - { out: nasdaq_01, file: data/nasdaq_01.txt }
          - { out: nasdaq_02, file: data/nasdaq_02.txt }
          - { out: nasdaq_03, file: data/nasdaq_03.txt }
          - { out: nasdaq_04, file: data/nasdaq_04.txt }
          - { out: nasdaq_05, file: data/nasdaq_05.txt }
          - { out: nasdaq_06, file: data/nasdaq_06.txt }
          - { out: nyse_01, file: data/nyse_01.txt }
          - { out: nyse_02, file: data/nyse_02.txt }
          - { out: nyse_03, file: data/nyse_03.txt }
          - { out: nyse_04, file: data/nyse_04.txt }
          - { out: nyse_05, file: data/nyse_05.txt }
          - { out: nyse_06, file: data/nyse_06.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/corrwl

      - name: Run Correction Watchlist
        run: |
          python scanners/correction_watchlist_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --tf 1d \
            --pivot_strength 2 \
            --min_hh 3 \
            --min_hl 3 \
            --min_pullback_pct 3 \
            --corr_bars_min 3 \
            --corr_bars_max 12 \
            --only_watchlist \
            --out api/corrwl/${{ matrix.market.out }}.json

      - uses: actions/upload-artifact@v4
        with:
          name: corrwl-api-${{ matrix.market.out }}
          path: api/corrwl/${{ matrix.market.out }}.json
          if-no-files-found: error

  # -------------------------
  # SIDEWAYS → UP
  # -------------------------
  sideways:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'sideways' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        market:
          - { out: nifty50, file: data/nifty50.txt }
          - { out: nse_01, file: data/nse_01.txt }
          - { out: nse_02, file: data/nse_02.txt }
          - { out: nse_03, file: data/nse_03.txt }
          - { out: nse_04, file: data/nse_04.txt }
          - { out: nse_05, file: data/nse_05.txt }
          - { out: nasdaq_01, file: data/nasdaq_01.txt }
          - { out: nasdaq_02, file: data/nasdaq_02.txt }
          - { out: nasdaq_03, file: data/nasdaq_03.txt }
          - { out: nasdaq_04, file: data/nasdaq_04.txt }
          - { out: nasdaq_05, file: data/nasdaq_05.txt }
          - { out: nasdaq_06, file: data/nasdaq_06.txt }
          - { out: nyse_01, file: data/nyse_01.txt }
          - { out: nyse_02, file: data/nyse_02.txt }
          - { out: nyse_03, file: data/nyse_03.txt }
          - { out: nyse_04, file: data/nyse_04.txt }
          - { out: nyse_05, file: data/nyse_05.txt }
          - { out: nyse_06, file: data/nyse_06.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/sidetoup

      - name: Run Sideways Scan
        run: |
          python scanners/side_to_up_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --only_in_channel \
            --sideways_threshold_pct 10 \
            --prior_trend_weeks 20 \
            --recent_trend_weeks 6 \
            --out api/sidetoup/${{ matrix.market.out }}.json

      - uses: actions/upload-artifact@v4
        with:
          name: sidetoup-api-${{ matrix.market.out }}
          path: api/sidetoup/${{ matrix.market.out }}.json
          if-no-files-found: error

  # -------------------------
  # DOWN → UP
  # -------------------------
  downtoup:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'downtoup' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        market:
          - { out: nifty50, file: data/nifty50.txt }
          - { out: nse_01, file: data/nse_01.txt }
          - { out: nse_02, file: data/nse_02.txt }
          - { out: nse_03, file: data/nse_03.txt }
          - { out: nse_04, file: data/nse_04.txt }
          - { out: nse_05, file: data/nse_05.txt }
          - { out: nasdaq_01, file: data/nasdaq_01.txt }
          - { out: nasdaq_02, file: data/nasdaq_02.txt }
          - { out: nasdaq_03, file: data/nasdaq_03.txt }
          - { out: nasdaq_04, file: data/nasdaq_04.txt }
          - { out: nasdaq_05, file: data/nasdaq_05.txt }
          - { out: nasdaq_06, file: data/nasdaq_06.txt }
          - { out: nyse_01, file: data/nyse_01.txt }
          - { out: nyse_02, file: data/nyse_02.txt }
          - { out: nyse_03, file: data/nyse_03.txt }
          - { out: nyse_04, file: data/nyse_04.txt }
          - { out: nyse_05, file: data/nyse_05.txt }
          - { out: nyse_06, file: data/nyse_06.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/downtoup

      - name: Run Down → Up Scan
        run: |
          python scanners/down_to_up_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --pivot_strength 1 \
            --near_resistance_pct 6 \
            --corr_max_pct 12 \
            --n_down 40 \
            --out api/downtoup/${{ matrix.market.out }}.json

      - uses: actions/upload-artifact@v4
        with:
          name: downtoup-api-${{ matrix.market.out }}
          path: api/downtoup/${{ matrix.market.out }}.json
          if-no-files-found: error

  # -------------------------
  # BULL FLAG
  # -------------------------
  bullflag:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'bullflag' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        market:
          - { out: nifty50, file: data/nifty50.txt }
          - { out: nse_01, file: data/nse_01.txt }
          - { out: nse_02, file: data/nse_02.txt }
          - { out: nse_03, file: data/nse_03.txt }
          - { out: nse_04, file: data/nse_04.txt }
          - { out: nse_05, file: data/nse_05.txt }
          - { out: nasdaq_01, file: data/nasdaq_01.txt }
          - { out: nasdaq_02, file: data/nasdaq_02.txt }
          - { out: nasdaq_03, file: data/nasdaq_03.txt }
          - { out: nasdaq_04, file: data/nasdaq_04.txt }
          - { out: nasdaq_05, file: data/nasdaq_05.txt }
          - { out: nasdaq_06, file: data/nasdaq_06.txt }
          - { out: nyse_01, file: data/nyse_01.txt }
          - { out: nyse_02, file: data/nyse_02.txt }
          - { out: nyse_03, file: data/nyse_03.txt }
          - { out: nyse_04, file: data/nyse_04.txt }
          - { out: nyse_05, file: data/nyse_05.txt }
          - { out: nyse_06, file: data/nyse_06.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/bullishflag

      - name: Run Bull Flag
        run: |
          python scanners/bull_flag_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --out api/bullishflag/${{ matrix.market.out }}.json

      - uses: actions/upload-artifact@v4
        with:
          name: bullishflag-api-${{ matrix.market.out }}
          path: api/bullishflag/${{ matrix.market.out }}.json
          if-no-files-found: error

  # -------------------------
  # CATCH ALL
  # -------------------------
  catchall:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'catchall' }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        market:
          - { out: nifty50, file: data/nifty50.txt }
          - { out: nse_01, file: data/nse_01.txt }
          - { out: nse_02, file: data/nse_02.txt }
          - { out: nse_03, file: data/nse_03.txt }
          - { out: nse_04, file: data/nse_04.txt }
          - { out: nse_05, file: data/nse_05.txt }
          - { out: nasdaq_01, file: data/nasdaq_01.txt }
          - { out: nasdaq_02, file: data/nasdaq_02.txt }
          - { out: nasdaq_03, file: data/nasdaq_03.txt }
          - { out: nasdaq_04, file: data/nasdaq_04.txt }
          - { out: nasdaq_05, file: data/nasdaq_05.txt }
          - { out: nasdaq_06, file: data/nasdaq_06.txt }
          - { out: nyse_01, file: data/nyse_01.txt }
          - { out: nyse_02, file: data/nyse_02.txt }
          - { out: nyse_03, file: data/nyse_03.txt }
          - { out: nyse_04, file: data/nyse_04.txt }
          - { out: nyse_05, file: data/nyse_05.txt }
          - { out: nyse_06, file: data/nyse_06.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/catchall

      - name: Run Catch All
        run: |
          python scanners/catchall_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --out api/catchall/${{ matrix.market.out }}.json

      - uses: actions/upload-artifact@v4
        with:
          name: catchall-api-${{ matrix.market.out }}
          path: api/catchall/${{ matrix.market.out }}.json
          if-no-files-found: error

  # -------------------------
  # FINAL PUBLISH (merge shards + push)
  # -------------------------
  publish:
    needs: [entry, corrwl, sideways, downtoup, bullflag, catchall]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Download ALL artifacts produced by matrix jobs (pattern + merge)
      - uses: actions/download-artifact@v4
        with:
          pattern: entry-api-*
          path: api/entry
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          pattern: corrwl-api-*
          path: api/corrwl
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          pattern: sidetoup-api-*
          path: api/sidetoup
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          pattern: downtoup-api-*
          path: api/downtoup
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          pattern: bullishflag-api-*
          path: api/bullishflag
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          pattern: catchall-api-*
          path: api/catchall
          merge-multiple: true

      # Merge sharded outputs -> stable filenames (nasdaq.json / nyse.json)
      - name: Merge shard outputs
        run: |
          python - <<'PY'
          import json, glob, os
          from collections import defaultdict

          def merge(pattern, out_file):
            files = sorted(glob.glob(pattern))
            if not files:
              return
            merged = {"meta": {"merged_from": files}, "counts": defaultdict(int), "data": []}
            for f in files:
              with open(f, "r", encoding="utf-8") as r:
                obj = json.load(r)
              if isinstance(obj, dict):
                merged["data"].extend(obj.get("data", []) or [])
                counts = obj.get("counts", {}) or {}
                for k, v in counts.items():
                  if isinstance(v, int):
                    merged["counts"][k] += v
            merged["counts"] = dict(merged["counts"])
            with open(out_file, "w", encoding="utf-8") as w:
              json.dump(merged, w, ensure_ascii=False)
            print("Wrote", out_file, "from", len(files), "files")

          for tab in ["entry", "corrwl", "sidetoup", "downtoup", "bullishflag", "catchall"]:
            os.makedirs(f"api/{tab}", exist_ok=True)
            merge(f"api/{tab}/nasdaq_*.json", f"api/{tab}/nasdaq.json")
            merge(f"api/{tab}/nyse_*.json", f"api/{tab}/nyse.json")
            merge(f"api/{tab}/nse_*.json", f"api/{tab}/nse.json")
          PY

      # Publish to gh-pages without losing files when switching branches
      - name: Publish API JSON to gh-pages
        run: |
          set -e

          mkdir -p /tmp/api_out
          rm -rf /tmp/api_out/api
          cp -r api /tmp/api_out/

          git fetch origin gh-pages
          rm -rf /tmp/ghp
          mkdir -p /tmp/ghp
          git worktree add /tmp/ghp gh-pages

          mkdir -p /tmp/ghp/api
          rm -rf /tmp/ghp/api/*
          cp -r /tmp/api_out/api/* /tmp/ghp/api/

          cd /tmp/ghp
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add api
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi

          git commit -m "Publish API JSON"
          git push origin gh-pages

          cd -
          git worktree remove /tmp/ghp --force
