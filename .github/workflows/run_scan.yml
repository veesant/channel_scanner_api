name: Weekly Channel Scan API (Multi-Market)

on:
  schedule:
    - cron: "30 20 * * 6"   # Saturday 3:30 PM EST (20:30 UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas numpy

      - name: Prepare output folders
        run: |
          mkdir -p api api/entry api/corrwl api/sidetoup api/downtoup api/bullishflag api/catchall

      # --------------------
      # Entry Signal tab for all three exchanges - Trend percentage
      # --------------------
      - name: Run Entry Signal Nifty50
        run: |
          python scanners/entry_sig_scanner.py \
            --tickers_file data/nifty50.txt \
            --out api/entry/nifty50.json

      - name: Run Entry Signal NASDAQ
        run: |
          python scanners/entry_sig_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --out api/entry/nasdaq.json

      - name: Run Entry Signal Russel
        run: |
          python scanners/entry_sig_scanner.py \
            --tickers_file data/russel.txt \
            --out api/entry/russel.json

      # --------------------
      # Correction Watchlist tab for all three exchanges - Correction Watchlist
      # --------------------

      - name: Run Entry Signal Nifty50
        run: |
          python scanners/correction_watchlist_scanner.py \
            --tickers_file data/nifty50.txt \
            --tf 1d --pivot_strength 2 --min_hh 3 --min_hl 3 --min_pullback_pct 3 \
            --corr_bars_min 3 --corr_bars_max 12 --only_watchlist \
            --out api/corrwl/nifty50.json
  
      - name: Run Entry Signal NASDAQ
        run: |
          python scanners/correction_watchlist_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --tf 1d --pivot_strength 2 --min_hh 3 --min_hl 3 --min_pullback_pct 3 \
            --corr_bars_min 3 --corr_bars_max 12 --only_watchlist \
            --out api/corrwl/nasdaq.json

      - name: Run Entry Signal Russel
        run: |
          python scanners/correction_watchlist_scanner.py \
            --tickers_file data/russel.txt \
            --tf 1d --pivot_strength 2 --min_hh 3 --min_hl 3 --min_pullback_pct 3 \
            --corr_bars_min 3 --corr_bars_max 12 --only_watchlist \
            --out api/corrwl/russel.json

      # --------------------
      # Sideways to UP trend tab for all three exchanges
      # --------------------

      - name: Run Sideways scan (NIFTY50)
        run: |
          python scanners/side_to_up_scanner.py \
            --tickers_file data/nifty50.txt \
            --only_in_channel \
            --sideways_threshold_pct 10 \
            --prior_trend_weeks 20 \
            --recent_trend_weeks 6 \
            --out api/sidetoup/nifty50.json

      - name: Run Sideways scan (NASDAQ)
        run: |
          python scanners/side_to_up_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --only_in_channel \
            --sideways_threshold_pct 10 \
            --prior_trend_weeks 20 \
            --recent_trend_weeks 6 \
            --out api/sidetoup/nasdaq.json

      - name: Run Sideways scan (Russel)
        run: |
          python scanners/side_to_up_scanner.py \
            --tickers_file data/russel.txt \
            --only_in_channel \
            --sideways_threshold_pct 10 \
            --prior_trend_weeks 20 \
            --recent_trend_weeks 6 \
            --out api/sidetoup/russel.json

      # --------------------
      # Down to UP trend tab for all three exchanges
      # --------------------

      - name: Run reversal scanner - Nifty
        run: |
          python scanners/down_to_up_scanner.py \
            --tickers_file data/nifty50.txt \
            --pivot_strength 1 \
            --near_resistance_pct 6 \
            --corr_max_pct 12 \
            --n_down 40 \
            --out api/downtoup/nifty50.json

      - name: Run reversal scanner - NASDAQ
        run: |
          python scanners/down_to_up_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --pivot_strength 1 \
            --near_resistance_pct 6 \
            --corr_max_pct 12 \
            --n_down 40 \
            --out api/downtoup/nasdaq.json

      - name: Run reversal scanner - Russel
        run: |
          python scanners/down_to_up_scanner.py \
            --tickers_file data/russel.txt \
            --pivot_strength 1 \
            --near_resistance_pct 6 \
            --corr_max_pct 12 \
            --n_down 40 \
            --out api/downtoup/russel.json

      # --------------------
      # Bullish Flag
      # --------------------

      - name: Run Bullish flag - Nifty
        run: |
          python scanners/bull_flag_scanner.py \
            --tickers_file data/nifty50.txt \
            --out api/bullishflag/nifty50.json

      - name: Run Bullish flag - NASDAQ
        run: |
          python scanners/bull_flag_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --out api/bullishflag/nasdaq.json

      - name: Run Bullish flag - Russel
        run: |
          python scanners/bull_flag_scanner.py \
            --tickers_file data/russel.txt \
            --out api/bullishflag/russel.json

      # --------------------
      # Catch-all tab
      # --------------------

      - name: Run Catchall - Nifty
        run: |
          python scanners/catchall_scanner.py \
            --tickers_file data/nifty50.txt \
            --out api/catchall/nifty50.json

      - name: Run Catchall - NASDAQ
        run: |
          python scanners/catchall_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --out api/catchall/nasdaq.json

      - name: Run Catchall - Russel
        run: |
          python scanners/catchall_scanner.py \
            --tickers_file data/russel.txt \
            --out api/catchall/russel.json

      # -----------------------------
      # Commit & Push
      # -----------------------------
      - name: Commit & push API updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add api

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update scan APIs (channels + HHHL + double bottom)"
          git push

      - name: Publish API JSON to gh-pages
        run: |
          # Save generated files somewhere temporary
          mkdir -p /tmp/api_out
          cp -r api /tmp/api_out/

          # Switch to gh-pages branch
          git fetch origin gh-pages
          git checkout gh-pages

          # Copy files into gh-pages branch (root)
          mkdir -p api
          cp -r /tmp/api_out/api/* api/

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add api
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi

          git commit -m "Publish API JSON (channels + HHHL + double bottom)"
          git push origin gh-pages
