name: Weekly Channel Scan API (Optimized)

on:
  schedule:
    - cron: "30 20 * * *"   # Daily 20:30 UTC
  workflow_dispatch:
    inputs:
      mode:
        description: "What to run"
        required: true
        default: "all"
        type: choice
        options:
          - entry_only
          - all
          - corr_wl
          - sideways
          - downtoup
          - bullflag
          - catchall

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.11"

# -------------------------
# ENTRY SIGNALS
# -------------------------
jobs:
  entry:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'entry_only' }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        market:
          - { name: nifty50, file: data/nifty50.txt }
          - { name: nasdaq,  file: data/nasdaq.txt }
          - { name: nyse,    file: data/nyse.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/entry

      - name: Run Entry Signal
        run: |
          python scanners/entry_sig_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --use_range_levels_for_entry \
            --recent_hl_lookback_bars 20 \
            --recent_hl_count 2 \
            --recent_hl_slope_min_pct_per_bar 0.02 \
            --out api/entry/${{ matrix.market.name }}.json

# -------------------------
# CORRECTION WATCHLIST
# -------------------------
  corrwl:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'corr_wl' }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        market:
          - { name: nifty50, file: data/nifty50.txt }
          - { name: nasdaq,  file: data/nasdaq.txt }
          - { name: nyse,    file: data/nyse.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/corrwl

      - name: Run Correction Watchlist
        run: |
          python scanners/correction_watchlist_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --tf 1d \
            --pivot_strength 2 \
            --min_hh 3 \
            --min_hl 3 \
            --min_pullback_pct 3 \
            --corr_bars_min 3 \
            --corr_bars_max 12 \
            --only_watchlist \
            --out api/corrwl/${{ matrix.market.name }}.json

# -------------------------
# SIDEWAYS → UP
# -------------------------
  sideways:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'sideways' }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        market:
          - { name: nifty50, file: data/nifty50.txt }
          - { name: nasdaq,  file: data/nasdaq.txt }
          - { name: nyse,    file: data/nyse.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/sidetoup

      - name: Run Sideways Scan
        run: |
          python scanners/side_to_up_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --only_in_channel \
            --sideways_threshold_pct 10 \
            --prior_trend_weeks 20 \
            --recent_trend_weeks 6 \
            --out api/sidetoup/${{ matrix.market.name }}.json

# -------------------------
# DOWN → UP
# -------------------------
  downtoup:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'downtoup' }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        market:
          - { name: nifty50, file: data/nifty50.txt }
          - { name: nasdaq,  file: data/nasdaq.txt }
          - { name: nyse,    file: data/nyse.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/downtoup

      - name: Run Down → Up Scan
        run: |
          python scanners/down_to_up_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --pivot_strength 1 \
            --near_resistance_pct 6 \
            --corr_max_pct 12 \
            --n_down 40 \
            --out api/downtoup/${{ matrix.market.name }}.json

# -------------------------
# BULL FLAG
# -------------------------
  bullflag:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'bullflag' }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        market:
          - { name: nifty50, file: data/nifty50.txt }
          - { name: nasdaq,  file: data/nasdaq.txt }
          - { name: nyse,    file: data/nyse.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/bullishflag

      - name: Run Bull Flag
        run: |
          python scanners/bull_flag_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --out api/bullishflag/${{ matrix.market.name }}.json

# -------------------------
# CATCH ALL
# -------------------------
  catchall:
    if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'catchall' }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        market:
          - { name: nifty50, file: data/nifty50.txt }
          - { name: nasdaq,  file: data/nasdaq.txt }
          - { name: nyse,    file: data/nyse.txt }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: pip install yfinance pandas numpy
      - run: mkdir -p api/catchall

      - name: Run Catch All
        run: |
          python scanners/catchall_scanner.py \
            --tickers_file ${{ matrix.market.file }} \
            --out api/catchall/${{ matrix.market.name }}.json

# -------------------------
# FINAL PUBLISH
# -------------------------
  publish:
    needs: [entry, corrwl, sideways, downtoup, bullflag, catchall]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Commit API results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add api
          git diff --cached --quiet || git commit -m "Update scan APIs"

      - name: Publish to gh-pages
        run: |
          git fetch origin gh-pages
          git checkout gh-pages
          mkdir -p api
          cp -r ../api/* api/
          git add api
          git diff --cached --quiet || git commit -m "Publish API JSON"
          git push origin gh-pages
