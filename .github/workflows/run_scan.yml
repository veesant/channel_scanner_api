name: Weekly Channel Scan API (Multi-Market)

on:
  schedule:
    - cron: "30 20 * * 6"   # Saturday 3:30 PM EST (20:30 UTC)
  workflow_dispatch:
    inputs:
      mode:
        description: "What to run"
        required: true
        default: "entry_only"
        type: choice
        options:
          - entry_only
          - all
          - corr_wl
          - sideways
          - downtoup
          - bullflag
          - catchall

permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas numpy

      - name: Prepare output folders
        run: |
          mkdir -p api api/entry api/corrwl api/sidetoup api/downtoup api/bullishflag api/catchall

      # --------------------
      # Entry Signal tab
      # Runs in: schedule, all, entry_only
      # --------------------
      - name: Run Entry Signal Nifty50
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'entry_only' }}
        run: |
          python scanners/entry_sig_scanner.py \
            --tickers_file data/nifty50.txt \
            --out api/entry/nifty50.json

      - name: Run Entry Signal NASDAQ
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'entry_only' }}
        run: |
          python scanners/entry_sig_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --out api/entry/nasdaq.json

      - name: Run Entry Signal Russel
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'entry_only' }}
        run: |
          python scanners/entry_sig_scanner.py \
            --tickers_file data/russel.txt \
            --out api/entry/russel.json

      # --------------------
      # Correction Watchlist tab
      # Runs in: schedule, all, corr_wl
      # --------------------
      - name: Run Correction Watchlist Nifty50
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'corr_wl' }}
        run: |
          python scanners/correction_watchlist_scanner.py \
            --tickers_file data/nifty50.txt \
            --tf 1d --pivot_strength 2 --min_hh 3 --min_hl 3 --min_pullback_pct 3 \
            --corr_bars_min 3 --corr_bars_max 12 --only_watchlist \
            --out api/corrwl/nifty50.json

      - name: Run Correction Watchlist NASDAQ
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'corr_wl' }}
        run: |
          python scanners/correction_watchlist_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --tf 1d --pivot_strength 2 --min_hh 3 --min_hl 3 --min_pullback_pct 3 \
            --corr_bars_min 3 --corr_bars_max 12 --only_watchlist \
            --out api/corrwl/nasdaq.json

      - name: Run Correction Watchlist Russel
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'corr_wl' }}
        run: |
          python scanners/correction_watchlist_scanner.py \
            --tickers_file data/russel.txt \
            --tf 1d --pivot_strength 2 --min_hh 3 --min_hl 3 --min_pullback_pct 3 \
            --corr_bars_min 3 --corr_bars_max 12 --only_watchlist \
            --out api/corrwl/russel.json

      # --------------------
      # Sideways to UP trend
      # Runs in: schedule, all, sideways
      # --------------------
      - name: Run Sideways scan (NIFTY50)
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'sideways' }}
        run: |
          python scanners/side_to_up_scanner.py \
            --tickers_file data/nifty50.txt \
            --only_in_channel \
            --sideways_threshold_pct 10 \
            --prior_trend_weeks 20 \
            --recent_trend_weeks 6 \
            --out api/sidetoup/nifty50.json

      - name: Run Sideways scan (NASDAQ)
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'sideways' }}
        run: |
          python scanners/side_to_up_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --only_in_channel \
            --sideways_threshold_pct 10 \
            --prior_trend_weeks 20 \
            --recent_trend_weeks 6 \
            --out api/sidetoup/nasdaq.json

      - name: Run Sideways scan (Russel)
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'sideways' }}
        run: |
          python scanners/side_to_up_scanner.py \
            --tickers_file data/russel.txt \
            --only_in_channel \
            --sideways_threshold_pct 10 \
            --prior_trend_weeks 20 \
            --recent_trend_weeks 6 \
            --out api/sidetoup/russel.json

      # --------------------
      # Down to UP trend
      # Runs in: schedule, all, downtoup
      # --------------------
      - name: Run reversal scanner - Nifty
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'downtoup' }}
        run: |
          python scanners/down_to_up_scanner.py \
            --tickers_file data/nifty50.txt \
            --pivot_strength 1 \
            --near_resistance_pct 6 \
            --corr_max_pct 12 \
            --n_down 40 \
            --out api/downtoup/nifty50.json

      - name: Run reversal scanner - NASDAQ
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'downtoup' }}
        run: |
          python scanners/down_to_up_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --pivot_strength 1 \
            --near_resistance_pct 6 \
            --corr_max_pct 12 \
            --n_down 40 \
            --out api/downtoup/nasdaq.json

      - name: Run reversal scanner - Russel
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'downtoup' }}
        run: |
          python scanners/down_to_up_scanner.py \
            --tickers_file data/russel.txt \
            --pivot_strength 1 \
            --near_resistance_pct 6 \
            --corr_max_pct 12 \
            --n_down 40 \
            --out api/downtoup/russel.json

      # --------------------
      # Bullish Flag
      # Runs in: schedule, all, bullflag
      # --------------------
      - name: Run Bullish flag - Nifty
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'bullflag' }}
        run: |
          python scanners/bull_flag_scanner.py \
            --tickers_file data/nifty50.txt \
            --out api/bullishflag/nifty50.json

      - name: Run Bullish flag - NASDAQ
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'bullflag' }}
        run: |
          python scanners/bull_flag_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --out api/bullishflag/nasdaq.json

      - name: Run Bullish flag - Russel
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'bullflag' }}
        run: |
          python scanners/bull_flag_scanner.py \
            --tickers_file data/russel.txt \
            --out api/bullishflag/russel.json

      # --------------------
      # Catch-all tab
      # Runs in: schedule, all, catchall
      # --------------------
      - name: Run Catchall - Nifty
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'catchall' }}
        run: |
          python scanners/catchall_scanner.py \
            --tickers_file data/nifty50.txt \
            --out api/catchall/nifty50.json

      - name: Run Catchall - NASDAQ
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'catchall' }}
        run: |
          python scanners/catchall_scanner.py \
            --tickers_file data/nasdaq100.txt \
            --out api/catchall/nasdaq.json

      - name: Run Catchall - Russel
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'catchall' }}
        run: |
          python scanners/catchall_scanner.py \
            --tickers_file data/russel.txt \
            --out api/catchall/russel.json

      # -----------------------------
      # Commit & Push (run when something ran)
      # -----------------------------
      - name: Commit & push API updates
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'entry_only' || github.event.inputs.mode == 'corr_wl' || github.event.inputs.mode == 'sideways' || github.event.inputs.mode == 'downtoup' || github.event.inputs.mode == 'bullflag' || github.event.inputs.mode == 'catchall' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add api

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update scan APIs (channels + HHHL + double bottom)"
          git push

      - name: Publish API JSON to gh-pages
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode == 'all' || github.event.inputs.mode == 'entry_only' || github.event.inputs.mode == 'corr_wl' || github.event.inputs.mode == 'sideways' || github.event.inputs.mode == 'downtoup' || github.event.inputs.mode == 'bullflag' || github.event.inputs.mode == 'catchall' }}
        run: |
          mkdir -p /tmp/api_out
          cp -r api /tmp/api_out/

          git fetch origin gh-pages
          git checkout gh-pages

          mkdir -p api
          cp -r /tmp/api_out/api/* api/

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add api
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi

          git commit -m "Publish API JSON (channels + HHHL + double bottom)"
          git push origin gh-pages
